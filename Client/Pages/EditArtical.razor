@page "/editartical/{id:int}"
@inject IArticalService ArticalService
@inject NavigationManager NavigationManager
@inject ICategoryService CategoryService
@inject ModalService _modalService

<div class="mb-2">
    <Breadcrumb>
        <BreadcrumbItem Href="/">Home</BreadcrumbItem>
        <BreadcrumbItem Href="/articals">Articals</BreadcrumbItem>
        <BreadcrumbItem>Edit</BreadcrumbItem>
    </Breadcrumb>
</div>
<hr />
<Card Hoverable Title="Edit Artical" Loading="_loading">
    <Form Model="@Artical"
          OnFinish="HandleValidSubmit"
          Layout="vertical">
        <ValidationSummary />
        <FormItem Label="Title">
            <Input @bind-Value="@context.Title" />
        </FormItem>
        <FormItem Label="Artical">
            <InputTextArea @bind-Value="@context.Body"  />
        </FormItem>
        <FormItem Label="Author">
            <Input @bind-Value="@context.Author" />
        </FormItem>
        <FormItem Label="Category" Required>
            <Select DataSource="@Categories"
                    DefaultActiveFirstOption="false"
                    ValueName="@nameof(Category.Id)"
                    LabelName="@nameof(Category.Name)"
                    @bind-Value="@context.CategoryId"
                    EnableSearch
                    AllowClear>
            </Select>
        </FormItem>
        <FormItem Label="Image">
            <InputFile OnChange="OnFileChange" /> <Avatar Src="@context.Image"></Avatar>
        </FormItem>
        <FormItem>
            <Button Type="@ButtonType.Primary" HtmlType="submit">
                Update
            </Button>
        </FormItem>
    </Form>
</Card>

@code{
    [CascadingParameter]
    public Error Error { get; set; }

    [Parameter]
    public int Id { get; set; }
    [Parameter]
    public EventCallback<string> OnChange { get; set; }
    public List<Category> Categories { get; set; } = new List<Category>();
    public Category Category { get; set; } = new Category();
    public Artical Artical { get; set; } = new Artical();
    bool _loading;

    protected async override Task OnInitializedAsync()
    {
        try
        {
            _loading = true;
            Artical = await ArticalService.GetArtical(Id);
            Categories = (await CategoryService.GetCategories()).ToList();
            _loading = false;
        }
        catch (Exception ex)
        {

            Error.ProcessError(ex);
        }

    }

    protected async Task OnFileChange(InputFileChangeEventArgs e)
    {
        var format = "images/png";
        var resizeImage = await e.File.RequestImageFileAsync(format, 300, 300);
        var buffer = new byte[resizeImage.Size];
        await resizeImage.OpenReadStream().ReadAsync(buffer);
        var imageData = $"data:{format};base64,{Convert.ToBase64String(buffer)}";
        Artical.Image = imageData;
        await OnChange.InvokeAsync(Artical.Image);
    }

    protected async Task HandleValidSubmit()
    {
        try
        {
            var result = await ArticalService.UpdateArtical(Artical);
            if (result != null)
            {
                HandleSuccess();
            }
        }
        catch (Exception ex)
        {

            Error.ProcessError(ex);
        }

    }

    private void HandleSuccess()
    {
        _modalService.Success(new ConfirmOptions()
        {
            Title = "Success.",
            Content = "Artical Updated Successfully.",
            OnOk = OnOkClick
        });
        NavigationManager.NavigateTo("/articals");
    }

    private Func<ModalClosingEventArgs, Task> OnOkClick = async (e) =>
    {
        await Task.Delay(1000);
    };
}